* Raddy 17 Mar 2018


SUBROUTINE TRICORDER
    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_F.FILE.CONTROL
    $INSERT I_F.STANDARD.SELECTION
	
	EXECUTE "COMO ON TRICORDER"
	MODE.VERBOSE = "OFF"
	GOSUB INIT
	GOSUB PROG.LOOP
	EXECUTE "COMO OF TRICORDER"
	
	RETURN

PROG.LOOP:
    Y.OPT = ""
    
    LOOP WHILE Y.OPT NE "X"        
        CRT 
        CRT "TRICORDER [A]LL/[T]able/[R]ecord/[F]ield/[S]how List/e[X]it/[V]erbose is " : MODE.VERBOSE : ") : "
        INPUT Y.OPT
        Y.OPT = UPCASE(Y.OPT)
        
        TXVB = "Option selected : " : Y.OPT
        GOSUB VERBOSE.MODE
        
        BEGIN CASE 
            CASE Y.OPT[1,1] EQ "A"
                GOSUB READ.SL
            CASE Y.OPT[1,1] EQ "T"
                GOSUB READ.SL
            CASE Y.OPT[1,1] EQ "R"
                GOSUB READ.SL
            CASE Y.OPT[1,1] EQ "F"
                GOSUB READ.SL
            CASE Y.OPT[1,1] EQ "S"
                GOSUB SHOW.LIST
            CASE Y.OPT[1,1] EQ "V"
                IF MODE.VERBOSE EQ "ON" THEN 
                    MODE.VERBOSE = "OFF"
                END ELSE
                    MODE.VERBOSE = "ON"
                END
                CRT "Verbose Mode " : MODE.VERBOSE

        END CASE
    REPEAT
    
    RETURN

INIT:
	FN.FILE.CONTROL = 'F.FILE.CONTROL'
	F.FILE.CONTROL = ''
	CALL OPF(FN.FILE.CONTROL,F.FILE.CONTROL)

	FN.STANDARD.SELECTION = 'F.STANDARD.SELECTION'
	F.STANDARD.SELECTION = ''
	CALL OPF(FN.STANDARD.SELECTION,F.STANDARD.SELECTION)

	RETURN

SHOW.LIST:
   	Y.OPT = Y.OPT[2,1]
    TXVB = "Show List : " : Y.OPT
    GOSUB VERBOSE.MODE

	READLIST Y.SAVED.LIST FROM "TRICORDER.SL" ELSE STOP
	SUMMARY.TOTAL = DCOUNT(Y.SAVED.LIST, @FM)
	
	TXVB = "List has been Loaded : " : SUMMARY.TOTAL
	GOSUB VERBOSE.MODE
	
	**LOOP
    **    WHILE READNEXT Y.TRIC FROM Y.SAVED.LIST DO
    
    FOR II = 1 TO SUMMARY.TOTAL
        Y.TRIC = Y.SAVED.LIST<II>
        
    	Y.OPER = FIELD(Y.TRIC, "|", 1)
    	Y.TABLE.NAME = FIELD(Y.TRIC, "|", 2)
    	Y.RECORD.NAME = FIELD(Y.TRIC, "|", 3)
    	Y.FIELD.NAME = FIELD(Y.TRIC, "|", 4)
    	Y.EXPECTED.VALUE = FIELD(Y.TRIC, "|", 5)
    	Y.REMARK = FIELD(Y.TRIC, "|", 6)
    	
    	BEGIN CASE 
    		CASE Y.OPER EQ "TABLE.ISEMPTY"
    		    IF Y.OPT = "A" OR Y.OPT = "T" THEN
    			    CRT Y.TRIC
    			END
    			
    		CASE Y.OPER EQ "RECORD.EXIST"
    		    IF Y.OPT = "A" OR Y.OPT = "R" THEN
    			    CRT Y.TRIC
        		END

    		CASE Y.OPER EQ "FIELD.TEST"
    		    IF Y.OPT = "A" OR Y.OPT = "F" THEN
    			    CRT Y.TRIC
                END			
    	END CASE
    **REPEAT
    NEXT
  
    RETURN
    
READ.SL:
    TXVB = "ASSERT : " : Y.OPT
    GOSUB VERBOSE.MODE
    
    IF ISALNUM(Y.OPT[2]) THEN 
        Y.OPT.NUM = Y.OPT[2]
        TXVB = "Processing only first  : " : Y.OPT.NUM : " records"
        GOSUB VERBOSE.MODE
    END

	READLIST Y.SAVED.LIST FROM "TRICORDER.SL" ELSE STOP
	SUMMARY.TOTAL = DCOUNT(Y.SAVED.LIST, @FM)
	
	TXVB = "List has been Loaded : " : SUMMARY.TOTAL
	GOSUB VERBOSE.MODE
	
	Y.REC = 0
	**LOOP
    **    WHILE READNEXT Y.TRIC FROM Y.SAVED.LIST DO
    FOR II = 1 TO SUMMARY.TOTAL
        Y.TRIC = Y.SAVED.LIST<II>
    
    	Y.OPER = FIELD(Y.TRIC, "|", 1)
    	Y.TABLE.NAME = FIELD(Y.TRIC, "|", 2)
    	Y.RECORD.NAME = FIELD(Y.TRIC, "|", 3)
    	Y.FIELD.NAME = FIELD(Y.TRIC, "|", 4)
    	Y.EXPECTED.VALUE = FIELD(Y.TRIC, "|", 5)
    	Y.REMARK = FIELD(Y.TRIC, "|", 6)
    	
    	BEGIN CASE 
    		CASE Y.OPER EQ "TABLE.ISEMPTY"
    		    IF Y.OPT = "A" OR Y.OPT = "T" THEN
    			    GOSUB TABLE.ISEMPTY
    			END
    			
    		CASE Y.OPER EQ "RECORD.EXIST"
    		    IF Y.OPT = "A" OR Y.OPT = "R" THEN
        			GOSUB RECORD.EXIST
        		END

    		CASE Y.OPER EQ "FIELD.TEST"
    		    IF Y.OPT = "A" OR Y.OPT = "F" THEN
        			GOSUB FIELD.TEST
                END			
    	END CASE
    	
    	IF Y.RESULT THEN Y.DETAIL.RESULT<-1> = Y.TRIC : "|" : Y.RESULT
        
        IF II GE Y.OPT.NUM THEN CONTINUE
    **REPEAT
    NEXT
    
	**GOSUB PRINT.DETAIL
	GOSUB PRINT.SUMMARY
      
	RETURN	
	
TABLE.ISEMPTY:	
	R.FC = ""
	R.SS = ""
	Y.RESULT = ""
	
	CALL F.READ(FN.FILE.CONTROL, Y.TABLE.NAME, R.FC, F.FILE.CONTROL, ERR)
	CALL F.READ(FN.STANDARD.SELECTION, Y.TABLE.NAME, R.SS, F.STANDARD.SELECTION, ERR)

	IF R.FC AND R.SS THEN
		SEL.CMD = "SELECT F." : Y.TABLE.NAME
		SEL.LIST = ""
		**CALL EB.READLIST(SEL.CMD, SEL.LIST, SEL.LIST.NAME, REC.COUNT, RETURN.ERROR)
		
		READLIST SEL.LIST FROM Y.TABLE.NAME ELSE STOP
		
		IF SEL.LIST THEN 
			Y.RESULT = ""
		END ELSE
			Y.RESULT = "TABLE EMPTY"
			GOSUB SUMMARIZE
		END
	END ELSE
		Y.RESULT = "TABLE NOT FOUND"
		GOSUB SUMMARIZE
	END
	F.FILE.CONTROL = ""
	F.STANDARD.SELECTION = ""
	SEL.LIST = ""
		
	RETURN

RECORD.EXIST:
	GOSUB TABLE.ISEMPTY
	
CRT "Y.RESULT = " : Y.RESULT

	IF Y.RESULT EQ "" THEN
		FN.TAB = "F." : Y.TABLE.NAME
CRT "FN.TAB = " : FN.TAB
		F.TAB = ""
		R.TAB = ""
		**CALL F.READ(FN.TAB, Y.RECORD.NAME, R.TAB, F.TAB, ERR)
CRT "R.TAB = " : R.TAB
		IF R.TAB THEN 
			Y.RESULT = ''
CRT "Y.RESULT = " : Y.RESULT
		END ELSE
			Y.RESULT = "RECORD NOT FOUND"
CRT "Y.RESULT = " : Y.RESULT
			GOSUB SUMMARIZE
		END
		F.TAB = ""
	END

	RETURN
	
FIELD.TEST:
	GOSUB RECORD.EXIST
	
	IF Y.RESULT EQ "" THEN
		GOSUB GET.FIELD.POSITION
		
		LOCATE Y.EXPECTED.VALUE IN R.TAB<Y.FIELD.NAME.POS> SETTING Y.SUB.POS THEN ELSE
			Y.RESULT = "VALUE NOT AS EXPECTED"
			GOSUB SUMMARIZE
		END
	END

	RETURN

* GET FIELD POSITION OF Y.FIELD.NAME FROM SS TABLE
GET.FIELD.POSITION:
	LOCATE Y.FIELD.NAME IN R.SS<SSL.SYS.FIELD.NAME> SETTING SS.POS THEN
		Y.FIELD.NAME.POS = R.SS<SSL.SYS.FIELD.NO, SS.POS>
	END

	RETURN

SUMMARIZE:
	SUMMARY.FOUND += 1
	Y.REMARK.1 = ""
	
	IF Y.REMARK EQ "" THEN 
		Y.REMARK.1 = "Remark empty : Table " : Y.TABLE.NAME : " " : Y.FIELD.NAME
	END ELSE
		Y.REMARK.1 = Y.REMARK
	END
		
	LOCATE Y.REMARK.1 IN REMARK.LIST SETTING REMARK.POS THEN ELSE
		REMARK.LIST<-1> = Y.REMARK.1
	END
	RETURN

PRINT.DETAIL:
	CRT STR("-",50)
	CRT "DETAIL REPORT"
	CRT STR("-",50)
	CRT CHANGE(Y.DETAIL.RESULT, @FM, CHAR(10))

	RETURN
	
PRINT.SUMMARY:
	Y.PCT1 = (SUMMARY.TOTAL - SUMMARY.FOUND) / SUMMARY.TOTAL * 100
	Y.PCT2 = SUMMARY.FOUND / SUMMARY.TOTAL * 100
	REMARK.LIST = CHANGE(REMARK.LIST,@FM,CHAR(10))

	CRT STR("-",50)
	CRT "SUMMARY"
	CRT STR("-",50)
	CRT "TOTAL CHECKED  : " : SUMMARY.TOTAL : " ( 100 % )" 
	CRT "TOTAL PASSED   : " : SUMMARY.TOTAL - SUMMARY.FOUND : " ( " : FMT(Y.PCT1, "L0") : " % )"
	CRT "PROBLEMS FOUND : " : SUMMARY.FOUND : " ( " : FMT(Y.PCT2, "L0") : " % )"
	CRT STR("-",50)
	CRT "RECOMMENDATION : "
	CRT STR("*",50)
	CRT REMARK.LIST	
	CRT STR("*",50)
	
	RETURN

VERBOSE.MODE:
    IF MODE.VERBOSE EQ "ON" THEN
        CRT TXVB
    END
    TXVB = ""
    RETURN

END